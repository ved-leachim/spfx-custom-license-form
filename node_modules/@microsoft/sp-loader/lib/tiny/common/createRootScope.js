// tslint:disable:export-name
import { __assign } from "tslib";
import { Environment, EnvironmentType, ServiceScope, _BrowserUtilities } from '@microsoft/sp-core-library';
import { _LogSource, _logSourceServiceKey, _TraceLogger } from '@microsoft/sp-diagnostics';
import { _DynamicDataUtilities } from '@microsoft/sp-dynamic-data';
import { AadTokenProvider, DigestCache, HttpClient, SPHttpClient, _AadConstants, _AadTokenProviders, _GraphHttpClientContext } from '@microsoft/sp-http';
import { PageContext } from '@microsoft/sp-page-context';
import { isMSALThirdPartyEnabled, isSafariAuthPatchEnbled } from './flights';
/**
 * Create a root service scope and initialize with SPFx services:
 *   - PageContext
 *   - DynamicDataManager
 *   - HttpClient
 *   - SPHttpClient
 *   - GraphHttpClientContext
 *   - DigestCache
 *
 * @param pageContext - the current SPPageContext
 *
 * @returns - the root scope
 */
export function createRootScope(pageContext) {
    var root = ServiceScope.startNewRoot();
    root.provide(_logSourceServiceKey, _LogSource.create('RootServiceScope'));
    root.createDefaultAndProvide(PageContext.serviceKey);
    root.createDefaultAndProvide(_DynamicDataUtilities.IDynamicDataManagerServiceKey);
    root.createDefaultAndProvide(HttpClient.serviceKey);
    var spHttpClient = root.createDefaultAndProvide(SPHttpClient.serviceKey);
    var graphContext = root.createDefaultAndProvide(_GraphHttpClientContext.serviceKey);
    var digestCache = root.createDefaultAndProvide(DigestCache.serviceKey);
    root.finish();
    initializeGraphHttpClient(pageContext, spHttpClient, graphContext);
    initializeDigestCache(pageContext, digestCache);
    return root;
}
function initializeGraphHttpClient(pageContext, spHttpClient, graphContext) {
    var aadInstanceUrl = pageContext.aadInstanceUrl, aadSessionId = pageContext.aadSessionId, aadTenantId = pageContext.aadTenantId, aadUserId = pageContext.aadUserId, CorrelationId = pageContext.CorrelationId, env = pageContext.env, isAnonymousGuestUser = pageContext.isAnonymousGuestUser, isExternalGuestUser = pageContext.isExternalGuestUser, msGraphEndpointUrl = pageContext.msGraphEndpointUrl, spfx3rdPartyServicePrincipalId = pageContext.spfx3rdPartyServicePrincipalId, spfxOBOFlowEnabled = pageContext.spfxOBOFlowEnabled, userPrincipalName = pageContext.userPrincipalName, webAbsoluteUrl = pageContext.webAbsoluteUrl, webServerRelativeUrl = pageContext.webServerRelativeUrl;
    if (Environment.type !== EnvironmentType.Local) {
        graphContext.initialize(webServerRelativeUrl, msGraphEndpointUrl, webAbsoluteUrl);
    }
    var defaultAadConfig = {
        aadInstanceUrl: aadInstanceUrl,
        aadSessionId: aadSessionId,
        aadTenantId: aadTenantId,
        aadUserId: aadUserId,
        redirectUri: window.location.origin + "/_forms/" + _AadConstants.SPFX_SINGLE_SIGN_ON_REPLY_URL,
        servicePrincipalId: spfx3rdPartyServicePrincipalId,
        spRequestGuid: CorrelationId,
        userPrincipalName: isAnonymousGuestUser || isExternalGuestUser ? undefined : userPrincipalName
    };
    var oboConfig;
    if (isMSALThirdPartyEnabled()) {
        defaultAadConfig.aadInstanceUrl =
            !env || env.toLowerCase() !== 'edog'
                ? 'https://login.microsoftonline.com'
                : 'https://login.windows-ppe.net';
    }
    if ((spfxOBOFlowEnabled && _BrowserUtilities.isMobileWebView()) ||
        _BrowserUtilities.isWebViewHosted() ||
        (isSafariAuthPatchEnbled() && /.*AppleWebKit.*Safari/.test(navigator.userAgent))) {
        oboConfig = { spHttpClient: spHttpClient, serverRelativeUrl: webAbsoluteUrl };
    }
    try {
        _AadTokenProviders._initialize(new AadTokenProvider(defaultAadConfig, oboConfig), __assign(__assign({}, defaultAadConfig), { servicePrincipalId: _AadConstants.PRE_AUTHORIZED_APP_PRINCIPAL_ID }));
    }
    catch (e) {
        _TraceLogger.logVerbose(_LogSource.create('RootServiceScope'), 'AadTokenProviders: Failed to initialize');
    }
}
function initializeDigestCache(pageContext, digestCache) {
    var formDigestTimeoutSeconds = pageContext.formDigestTimeoutSeconds, formDigestValue = pageContext.formDigestValue, serverTime = pageContext.serverTime, webAbsoluteUrl = pageContext.webAbsoluteUrl, webServerRelativeUrl = pageContext.webServerRelativeUrl;
    // Value of serverTime is same as what comes as part of formDigestValue
    // but is in locale neutral ISO 8601 format. So it will get correctly
    // parsed by Date class irrespective of client locale.
    // serverTime is accurate to the order of ms, while DateTime which comes
    // as part of formDigestValue is trimmed to order of seconds. Subtract
    // 30s from expirationTimeStamp to avoid any timing errors b/w server and client
    var expirationTimestamp = new Date(serverTime).getTime() + 1000 * formDigestTimeoutSeconds - 30000;
    for (var _i = 0, _a = [webAbsoluteUrl, webServerRelativeUrl]; _i < _a.length; _i++) {
        var url = _a[_i];
        digestCache.addDigestToCache(url, formDigestValue, expirationTimestamp);
    }
}
//# sourceMappingURL=createRootScope.js.map