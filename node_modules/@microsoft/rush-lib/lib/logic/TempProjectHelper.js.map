{"version":3,"file":"TempProjectHelper.js","sourceRoot":"","sources":["../../src/logic/TempProjectHelper.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA,oEAAwF;AACxF,yCAA2B;AAC3B,2CAA6B;AAI7B,mDAAgD;AAEhD,qEAAqE;AACrE,+BAA+B;AAE/B,MAAa,iBAAiB;IAG5B,YAAmB,iBAAoC;QACrD,IAAI,CAAC,kBAAkB,GAAG,iBAAiB,CAAC;IAC9C,CAAC;IAED;;OAEG;IACI,wBAAwB,CAAC,WAAqC;QACnE,8BAAU,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,kBAAkB,CAAC,gBAAgB,EAAE,UAAU,CAAC,CAAC,CAAC;QAC5F,MAAM,WAAW,GAAW,IAAI,CAAC,kBAAkB,CAAC,WAAW,CAAC,CAAC;QACjE,MAAM,iBAAiB,GAAW,IAAI,CAAC,oBAAoB,CAAC,WAAW,CAAC,CAAC;QAEzE,8BAAU,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;QAEnC,2EAA2E;QAC3E,MAAM,gBAAgB,GAAW,SAAS,CAAC;QAE3C,MAAM,UAAU,GAAsB;YACpC,IAAI,EAAE,IAAI;YACV,IAAI,EAAE,WAAW;YACjB,GAAG,EAAE,iBAAiB;YACtB,QAAQ,EAAE,IAAI;YACd,OAAO,EAAE,IAAI;YACb,KAAK,EAAE,IAAI;YACX,IAAI,EAAE,IAAI;YACV,MAAM,EAAE,gBAAgB;YACxB,MAAM,EAAE,CAAC,IAAY,EAAE,IAAkB,EAAW,EAAE;gBACpD,IACE,CAAC,IAAI,CAAC,kBAAkB,CAAC,wBAAwB,CAAC,aAAa,CAAC,oCAAoC,EACpG;oBACA,IAAI,CAAC,IAAI;wBACP,CAAC,IAAI,CAAC,IAAI,GAAG,CAAC,KAAK,CAAC,oBAAwB,sBAA0B,sBAA2B,CAAC;iBACrG;gBACD,OAAO,IAAI,CAAC;YACd,CAAC;SACmB,CAAC;QACvB,yBAAyB;QACzB,GAAG,CAAC,MAAM,CAAC,UAAU,EAAE,kCAA2B,CAAC,CAAC;IACtD,CAAC;IAED;;;OAGG;IACI,kBAAkB,CAAC,OAAiC;QACzD,OAAO,IAAI,CAAC,IAAI,CACd,IAAI,CAAC,kBAAkB,CAAC,gBAAgB,EACxC,6BAAa,CAAC,0BAA0B,EACxC,GAAG,OAAO,CAAC,uBAAuB,MAAM,CACzC,CAAC;IACJ,CAAC;IAEM,oBAAoB,CAAC,WAAqC;QAC/D,MAAM,uBAAuB,GAAW,WAAW,CAAC,uBAAuB,CAAC;QAC5E,OAAO,IAAI,CAAC,IAAI,CACd,IAAI,CAAC,kBAAkB,CAAC,gBAAgB,EACxC,6BAAa,CAAC,0BAA0B,EACxC,uBAAuB,CACxB,CAAC;IACJ,CAAC;CACF;AA/DD,8CA+DC","sourcesContent":["import { FileConstants, FileSystem, PosixModeBits } from '@rushstack/node-core-library';\r\nimport * as tar from 'tar';\r\nimport * as path from 'path';\r\n\r\nimport { RushConfigurationProject } from '../api/RushConfigurationProject';\r\nimport { RushConfiguration } from '../api/RushConfiguration';\r\nimport { RushConstants } from './RushConstants';\r\n\r\n// The PosixModeBits are intended to be used with bitwise operations.\r\n/* eslint-disable no-bitwise */\r\n\r\nexport class TempProjectHelper {\r\n  private _rushConfiguration: RushConfiguration;\r\n\r\n  public constructor(rushConfiguration: RushConfiguration) {\r\n    this._rushConfiguration = rushConfiguration;\r\n  }\r\n\r\n  /**\r\n   * Deletes the existing tarball and creates a tarball for the given rush project\r\n   */\r\n  public createTempProjectTarball(rushProject: RushConfigurationProject): void {\r\n    FileSystem.ensureFolder(path.resolve(this._rushConfiguration.commonTempFolder, 'projects'));\r\n    const tarballFile: string = this.getTarballFilePath(rushProject);\r\n    const tempProjectFolder: string = this.getTempProjectFolder(rushProject);\r\n\r\n    FileSystem.deleteFile(tarballFile);\r\n\r\n    // NPM expects the root of the tarball to have a directory called 'package'\r\n    const npmPackageFolder: string = 'package';\r\n\r\n    const tarOptions: tar.CreateOptions = {\r\n      gzip: true,\r\n      file: tarballFile,\r\n      cwd: tempProjectFolder,\r\n      portable: true,\r\n      noMtime: true,\r\n      noPax: true,\r\n      sync: true,\r\n      prefix: npmPackageFolder,\r\n      filter: (path: string, stat: tar.FileStat): boolean => {\r\n        if (\r\n          !this._rushConfiguration.experimentsConfiguration.configuration.noChmodFieldInTarHeaderNormalization\r\n        ) {\r\n          stat.mode =\r\n            (stat.mode & ~0x1ff) | PosixModeBits.AllRead | PosixModeBits.UserWrite | PosixModeBits.AllExecute;\r\n        }\r\n        return true;\r\n      }\r\n    } as tar.CreateOptions;\r\n    // create the new tarball\r\n    tar.create(tarOptions, [FileConstants.PackageJson]);\r\n  }\r\n\r\n  /**\r\n   * Gets the path to the tarball\r\n   * Example: \"C:\\MyRepo\\common\\temp\\projects\\my-project-2.tgz\"\r\n   */\r\n  public getTarballFilePath(project: RushConfigurationProject): string {\r\n    return path.join(\r\n      this._rushConfiguration.commonTempFolder,\r\n      RushConstants.rushTempProjectsFolderName,\r\n      `${project.unscopedTempProjectName}.tgz`\r\n    );\r\n  }\r\n\r\n  public getTempProjectFolder(rushProject: RushConfigurationProject): string {\r\n    const unscopedTempProjectName: string = rushProject.unscopedTempProjectName;\r\n    return path.join(\r\n      this._rushConfiguration.commonTempFolder,\r\n      RushConstants.rushTempProjectsFolderName,\r\n      unscopedTempProjectName\r\n    );\r\n  }\r\n}\r\n"]}