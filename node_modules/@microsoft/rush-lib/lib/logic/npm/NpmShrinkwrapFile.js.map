{"version":3,"file":"NpmShrinkwrapFile.js","sourceRoot":"","sources":["../../../src/logic/npm/NpmShrinkwrapFile.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as os from 'os';\r\n\r\nimport { JsonFile, FileSystem, InternalError } from '@rushstack/node-core-library';\r\n\r\nimport { BaseShrinkwrapFile } from '../base/BaseShrinkwrapFile';\r\nimport { DependencySpecifier } from '../DependencySpecifier';\r\n\r\ninterface INpmShrinkwrapDependencyJson {\r\n  version: string;\r\n  from: string;\r\n  resolved: string;\r\n  dependencies: { [dependency: string]: INpmShrinkwrapDependencyJson };\r\n}\r\n\r\ninterface INpmShrinkwrapJson {\r\n  name: string;\r\n  version: string;\r\n  dependencies: { [dependency: string]: INpmShrinkwrapDependencyJson };\r\n}\r\n\r\nexport class NpmShrinkwrapFile extends BaseShrinkwrapFile {\r\n  private _shrinkwrapJson: INpmShrinkwrapJson;\r\n\r\n  private constructor(shrinkwrapJson: INpmShrinkwrapJson) {\r\n    super();\r\n    this._shrinkwrapJson = shrinkwrapJson;\r\n\r\n    // Normalize the data\r\n    if (!this._shrinkwrapJson.version) {\r\n      this._shrinkwrapJson.version = '';\r\n    }\r\n    if (!this._shrinkwrapJson.name) {\r\n      this._shrinkwrapJson.name = '';\r\n    }\r\n    if (!this._shrinkwrapJson.dependencies) {\r\n      this._shrinkwrapJson.dependencies = {};\r\n    }\r\n  }\r\n\r\n  public static loadFromFile(shrinkwrapJsonFilename: string): NpmShrinkwrapFile | undefined {\r\n    let data: string | undefined = undefined;\r\n    try {\r\n      if (!FileSystem.exists(shrinkwrapJsonFilename)) {\r\n        return undefined; // file does not exist\r\n      }\r\n\r\n      // We don't use JsonFile/jju here because shrinkwrap.json is a special NPM file format\r\n      // and typically very large, so we want to load it the same way that NPM does.\r\n      data = FileSystem.readFile(shrinkwrapJsonFilename);\r\n      if (data.charCodeAt(0) === 0xfeff) {\r\n        // strip BOM\r\n        data = data.slice(1);\r\n      }\r\n\r\n      return new NpmShrinkwrapFile(JSON.parse(data));\r\n    } catch (error) {\r\n      throw new Error(`Error reading \"${shrinkwrapJsonFilename}\":` + os.EOL + `  ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /** @override */\r\n  public getTempProjectNames(): ReadonlyArray<string> {\r\n    return this._getTempProjectNames(this._shrinkwrapJson.dependencies);\r\n  }\r\n\r\n  /** @override */\r\n  protected serialize(): string {\r\n    return JsonFile.stringify(this._shrinkwrapJson);\r\n  }\r\n\r\n  /** @override */\r\n  protected getTopLevelDependencyVersion(dependencyName: string): DependencySpecifier | undefined {\r\n    // First, check under tempProjectName, as this is the first place we look during linking.\r\n    const dependencyJson: INpmShrinkwrapDependencyJson | undefined = NpmShrinkwrapFile.tryGetValue(\r\n      this._shrinkwrapJson.dependencies,\r\n      dependencyName\r\n    );\r\n\r\n    if (!dependencyJson) {\r\n      return undefined;\r\n    }\r\n\r\n    return new DependencySpecifier(dependencyName, dependencyJson.version);\r\n  }\r\n\r\n  /**\r\n   * @param dependencyName the name of the dependency to get a version for\r\n   * @param tempProjectName the name of the temp project to check for this dependency\r\n   * @param versionRange Not used, just exists to satisfy abstract API contract\r\n   * @override\r\n   */\r\n  protected tryEnsureDependencyVersion(\r\n    dependencySpecifier: DependencySpecifier,\r\n    tempProjectName: string\r\n  ): DependencySpecifier | undefined {\r\n    // First, check under tempProjectName, as this is the first place we look during linking.\r\n    let dependencyJson: INpmShrinkwrapDependencyJson | undefined = undefined;\r\n\r\n    const tempDependency: INpmShrinkwrapDependencyJson | undefined = NpmShrinkwrapFile.tryGetValue(\r\n      this._shrinkwrapJson.dependencies,\r\n      tempProjectName\r\n    );\r\n    if (tempDependency && tempDependency.dependencies) {\r\n      dependencyJson = NpmShrinkwrapFile.tryGetValue(\r\n        tempDependency.dependencies,\r\n        dependencySpecifier.packageName\r\n      );\r\n    }\r\n\r\n    // Otherwise look at the root of the shrinkwrap file\r\n    if (!dependencyJson) {\r\n      return this.getTopLevelDependencyVersion(dependencySpecifier.packageName);\r\n    }\r\n\r\n    return new DependencySpecifier(dependencySpecifier.packageName, dependencyJson.version);\r\n  }\r\n\r\n  /** @override */\r\n  public getWorkspaceKeys(): ReadonlyArray<string> {\r\n    throw new InternalError('Not implemented');\r\n  }\r\n\r\n  /** @override */\r\n  public getWorkspaceKeyByPath(workspaceRoot: string, projectFolder: string): string {\r\n    throw new InternalError('Not implemented');\r\n  }\r\n\r\n  /** @override */\r\n  protected getWorkspaceDependencyVersion(\r\n    dependencySpecifier: DependencySpecifier,\r\n    workspaceKey: string\r\n  ): DependencySpecifier | undefined {\r\n    throw new InternalError('Not implemented');\r\n  }\r\n}\r\n"]}