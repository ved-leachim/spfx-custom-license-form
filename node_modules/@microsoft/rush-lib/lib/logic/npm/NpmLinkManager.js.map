{"version":3,"file":"NpmLinkManager.js","sourceRoot":"","sources":["../../../src/logic/npm/NpmLinkManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport colors from 'colors';\r\nimport * as os from 'os';\r\nimport * as path from 'path';\r\nimport * as semver from 'semver';\r\nimport * as tar from 'tar';\r\nimport readPackageTree = require('read-package-tree');\r\nimport { FileSystem, FileConstants, LegacyAdapters } from '@rushstack/node-core-library';\r\n\r\nimport { RushConstants } from '../../logic/RushConstants';\r\nimport { RushConfigurationProject } from '../../api/RushConfigurationProject';\r\nimport { Utilities } from '../../utilities/Utilities';\r\nimport { NpmPackage, IResolveOrCreateResult, PackageDependencyKind } from './NpmPackage';\r\nimport { PackageLookup } from '../PackageLookup';\r\nimport { BaseLinkManager, SymlinkKind } from '../base/BaseLinkManager';\r\n\r\ninterface IQueueItem {\r\n  // A project from somewhere under \"common/temp/node_modules\"\r\n  commonPackage: NpmPackage;\r\n\r\n  // A symlinked virtual package that we will create somewhere under \"this-project/node_modules\"\r\n  localPackage: NpmPackage;\r\n\r\n  // If we encounter a dependency listed in cyclicDependencyProjects, this will be set to the root\r\n  // of the localPackage subtree where we will stop creating local links.\r\n  cyclicSubtreeRoot: NpmPackage | undefined;\r\n}\r\n\r\nexport class NpmLinkManager extends BaseLinkManager {\r\n  protected async _linkProjects(): Promise<void> {\r\n    const npmPackage: readPackageTree.Node = await LegacyAdapters.convertCallbackToPromise<\r\n      readPackageTree.Node,\r\n      Error,\r\n      string\r\n    >(readPackageTree, this._rushConfiguration.commonTempFolder);\r\n\r\n    const commonRootPackage: NpmPackage = NpmPackage.createFromNpm(npmPackage);\r\n\r\n    const commonPackageLookup: PackageLookup = new PackageLookup();\r\n    commonPackageLookup.loadTree(commonRootPackage);\r\n\r\n    for (const rushProject of this._rushConfiguration.projects) {\r\n      console.log(os.EOL + 'LINKING: ' + rushProject.packageName);\r\n      this._linkProject(rushProject, commonRootPackage, commonPackageLookup);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * This is called once for each local project from Rush.json.\r\n   * @param project             The local project that we will create symlinks for\r\n   * @param commonRootPackage   The common/temp/package.json package\r\n   * @param commonPackageLookup A dictionary for finding packages under common/temp/node_modules\r\n   */\r\n  private _linkProject(\r\n    project: RushConfigurationProject,\r\n    commonRootPackage: NpmPackage,\r\n    commonPackageLookup: PackageLookup\r\n  ): void {\r\n    let commonProjectPackage: NpmPackage | undefined = commonRootPackage.getChildByName(\r\n      project.tempProjectName\r\n    ) as NpmPackage;\r\n    if (!commonProjectPackage) {\r\n      // Normally we would expect the temp project to have been installed into the common\\node_modules\r\n      // folder.  However, if it was recently added, \"rush install\" doesn't technically require\r\n      // this, as long as its dependencies can be found at the root of the NPM shrinkwrap file.\r\n      // This avoids the need to run \"rush generate\" unnecessarily.\r\n\r\n      // Example: \"project1\"\r\n      const unscopedTempProjectName: string = this._rushConfiguration.packageNameParser.getUnscopedName(\r\n        project.tempProjectName\r\n      );\r\n\r\n      // Example: \"C:\\MyRepo\\common\\temp\\projects\\project1\r\n      const extractedFolder: string = path.join(\r\n        this._rushConfiguration.commonTempFolder,\r\n        RushConstants.rushTempProjectsFolderName,\r\n        unscopedTempProjectName\r\n      );\r\n\r\n      // Example: \"C:\\MyRepo\\common\\temp\\projects\\project1.tgz\"\r\n      const tarballFile: string = path.join(\r\n        this._rushConfiguration.commonTempFolder,\r\n        RushConstants.rushTempProjectsFolderName,\r\n        unscopedTempProjectName + '.tgz'\r\n      );\r\n\r\n      // Example: \"C:\\MyRepo\\common\\temp\\projects\\project1\\package.json\"\r\n      const packageJsonFilename: string = path.join(extractedFolder, 'package', FileConstants.PackageJson);\r\n\r\n      Utilities.createFolderWithRetry(extractedFolder);\r\n      tar.extract({\r\n        cwd: extractedFolder,\r\n        file: tarballFile,\r\n        sync: true\r\n      });\r\n\r\n      // Example: \"C:\\MyRepo\\common\\temp\\node_modules\\@rush-temp\\project1\"\r\n      const installFolderName: string = path.join(\r\n        this._rushConfiguration.commonTempFolder,\r\n        RushConstants.nodeModulesFolderName,\r\n        RushConstants.rushTempNpmScope,\r\n        unscopedTempProjectName\r\n      );\r\n\r\n      commonProjectPackage = NpmPackage.createVirtualTempPackage(packageJsonFilename, installFolderName);\r\n\r\n      // remove the extracted tarball contents\r\n      FileSystem.deleteFile(packageJsonFilename);\r\n      FileSystem.deleteFile(extractedFolder);\r\n\r\n      commonRootPackage.addChild(commonProjectPackage);\r\n    }\r\n\r\n    // TODO: Validate that the project's package.json still matches the common folder\r\n    const localProjectPackage: NpmPackage = NpmPackage.createLinkedNpmPackage(\r\n      project.packageJsonEditor.name,\r\n      commonProjectPackage.version,\r\n      commonProjectPackage.dependencies,\r\n      project.projectFolder\r\n    );\r\n\r\n    const queue: IQueueItem[] = [];\r\n    queue.push({\r\n      commonPackage: commonProjectPackage,\r\n      localPackage: localProjectPackage,\r\n      cyclicSubtreeRoot: undefined\r\n    });\r\n\r\n    for (;;) {\r\n      const queueItem: IQueueItem | undefined = queue.shift();\r\n      if (!queueItem) {\r\n        break;\r\n      }\r\n\r\n      // A project from somewhere under \"common/temp/node_modules\"\r\n      const commonPackage: NpmPackage = queueItem.commonPackage;\r\n\r\n      // A symlinked virtual package somewhere under \"this-project/node_modules\",\r\n      // where \"this-project\" corresponds to the \"project\" parameter for linkProject().\r\n      const localPackage: NpmPackage = queueItem.localPackage;\r\n\r\n      // If we encounter a dependency listed in cyclicDependencyProjects, this will be set to the root\r\n      // of the localPackage subtree where we will stop creating local links.\r\n      const cyclicSubtreeRoot: NpmPackage | undefined = queueItem.cyclicSubtreeRoot;\r\n\r\n      // NOTE: It's important that this traversal follows the dependencies in the Common folder,\r\n      // because for Rush projects this will be the union of\r\n      // devDependencies / dependencies / optionalDependencies.\r\n      for (const dependency of commonPackage.dependencies) {\r\n        let startingCyclicSubtree: boolean = false;\r\n\r\n        // Should this be a \"local link\" to a top-level Rush project (i.e. versus a regular link\r\n        // into the Common folder)?\r\n        const matchedRushPackage:\r\n          | RushConfigurationProject\r\n          | undefined = this._rushConfiguration.getProjectByName(dependency.name);\r\n\r\n        if (matchedRushPackage) {\r\n          const matchedVersion: string = matchedRushPackage.packageJsonEditor.version;\r\n\r\n          // The dependency name matches an Rush project, but are there any other reasons not\r\n          // to create a local link?\r\n          if (cyclicSubtreeRoot) {\r\n            // DO NOT create a local link, because this is part of an existing\r\n            // cyclicDependencyProjects subtree\r\n          } else if (project.cyclicDependencyProjects.has(dependency.name)) {\r\n            // DO NOT create a local link, because we are starting a new\r\n            // cyclicDependencyProjects subtree\r\n            startingCyclicSubtree = true;\r\n          } else if (\r\n            dependency.kind !== PackageDependencyKind.LocalLink &&\r\n            !semver.satisfies(matchedVersion, dependency.versionRange)\r\n          ) {\r\n            // DO NOT create a local link, because the local project's version isn't SemVer compatible.\r\n\r\n            // (Note that in order to make version bumping work as expected, we ignore SemVer for\r\n            // immediate dependencies of top-level projects, indicated by PackageDependencyKind.LocalLink.\r\n            // Is this wise?)\r\n\r\n            console.log(\r\n              colors.yellow(\r\n                `Rush will not locally link ${dependency.name} for ${localPackage.name}` +\r\n                  ` because the requested version \"${dependency.versionRange}\" is incompatible` +\r\n                  ` with the local version ${matchedVersion}`\r\n              )\r\n            );\r\n          } else {\r\n            // Yes, it is compatible, so create a symlink to the Rush project.\r\n            // Is the dependency already resolved?\r\n            const resolution: IResolveOrCreateResult = localPackage.resolveOrCreate(dependency.name);\r\n\r\n            if (!resolution.found || resolution.found.version !== matchedVersion) {\r\n              // We did not find a suitable match, so place a new local package that\r\n              // symlinks to the Rush project\r\n              const newLocalFolderPath: string = path.join(\r\n                resolution.parentForCreate!.folderPath,\r\n                'node_modules',\r\n                dependency.name\r\n              );\r\n\r\n              const newLocalPackage: NpmPackage = NpmPackage.createLinkedNpmPackage(\r\n                dependency.name,\r\n                matchedVersion,\r\n                // Since matchingRushProject does not have a parent, its dependencies are\r\n                // guaranteed to be already fully resolved inside its node_modules folder.\r\n                [],\r\n                newLocalFolderPath\r\n              );\r\n\r\n              newLocalPackage.symlinkTargetFolderPath = matchedRushPackage.projectFolder;\r\n\r\n              resolution.parentForCreate!.addChild(newLocalPackage);\r\n\r\n              // (There are no dependencies, so we do not need to push it onto the queue.)\r\n            }\r\n\r\n            continue;\r\n          }\r\n        }\r\n\r\n        // We can't symlink to an Rush project, so instead we will symlink to a folder\r\n        // under the \"Common\" folder\r\n        const commonDependencyPackage: NpmPackage | undefined = commonPackage.resolve(dependency.name);\r\n        if (commonDependencyPackage) {\r\n          // This is the version that was chosen when \"npm install\" ran in the common folder\r\n          const effectiveDependencyVersion: string | undefined = commonDependencyPackage.version;\r\n\r\n          // Is the dependency already resolved?\r\n          let resolution: IResolveOrCreateResult;\r\n          if (!cyclicSubtreeRoot || !matchedRushPackage) {\r\n            // Perform normal module resolution.\r\n            resolution = localPackage.resolveOrCreate(dependency.name);\r\n          } else {\r\n            // We are inside a cyclicDependencyProjects subtree (i.e. cyclicSubtreeRoot != undefined),\r\n            // and the dependency is a local project (i.e. matchedRushPackage != undefined), so\r\n            // we use a special module resolution strategy that places everything under the\r\n            // cyclicSubtreeRoot.\r\n            resolution = localPackage.resolveOrCreate(dependency.name, cyclicSubtreeRoot);\r\n          }\r\n\r\n          if (!resolution.found || resolution.found.version !== effectiveDependencyVersion) {\r\n            // We did not find a suitable match, so place a new local package\r\n\r\n            const newLocalFolderPath: string = path.join(\r\n              resolution.parentForCreate!.folderPath,\r\n              'node_modules',\r\n              commonDependencyPackage.name\r\n            );\r\n\r\n            const newLocalPackage: NpmPackage = NpmPackage.createLinkedNpmPackage(\r\n              commonDependencyPackage.name,\r\n              commonDependencyPackage.version,\r\n              commonDependencyPackage.dependencies,\r\n              newLocalFolderPath\r\n            );\r\n\r\n            const commonPackageFromLookup: NpmPackage | undefined = commonPackageLookup.getPackage(\r\n              newLocalPackage.nameAndVersion\r\n            ) as NpmPackage;\r\n            if (!commonPackageFromLookup) {\r\n              throw new Error(\r\n                `The ${localPackage.name}@${localPackage.version} package was not found` +\r\n                  ` in the common folder`\r\n              );\r\n            }\r\n            newLocalPackage.symlinkTargetFolderPath = commonPackageFromLookup.folderPath;\r\n\r\n            let newCyclicSubtreeRoot: NpmPackage | undefined = cyclicSubtreeRoot;\r\n            if (startingCyclicSubtree) {\r\n              // If we are starting a new subtree, then newLocalPackage will be its root\r\n              // NOTE: cyclicSubtreeRoot is guaranteed to be undefined here, since we never start\r\n              // a new tree inside an existing tree\r\n              newCyclicSubtreeRoot = newLocalPackage;\r\n            }\r\n\r\n            resolution.parentForCreate!.addChild(newLocalPackage);\r\n            queue.push({\r\n              commonPackage: commonDependencyPackage,\r\n              localPackage: newLocalPackage,\r\n              cyclicSubtreeRoot: newCyclicSubtreeRoot\r\n            });\r\n          }\r\n        } else {\r\n          if (dependency.kind !== PackageDependencyKind.Optional) {\r\n            throw new Error(\r\n              `The dependency \"${dependency.name}\" needed by \"${localPackage.name}\"` +\r\n                ` was not found in the common folder -- do you need to run \"rush install\"?`\r\n            );\r\n          } else {\r\n            console.log('Skipping optional dependency: ' + dependency.name);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // When debugging, you can uncomment this line to dump the data structure\r\n    // to the console:\r\n    // localProjectPackage.printTree();\r\n\r\n    NpmLinkManager._createSymlinksForTopLevelProject(localProjectPackage);\r\n\r\n    // Also symlink the \".bin\" folder\r\n    if (localProjectPackage.children.length > 0) {\r\n      const commonBinFolder: string = path.join(\r\n        this._rushConfiguration.commonTempFolder,\r\n        'node_modules',\r\n        '.bin'\r\n      );\r\n      const projectBinFolder: string = path.join(localProjectPackage.folderPath, 'node_modules', '.bin');\r\n\r\n      if (FileSystem.exists(commonBinFolder)) {\r\n        NpmLinkManager._createSymlink({\r\n          linkTargetPath: commonBinFolder,\r\n          newLinkPath: projectBinFolder,\r\n          symlinkKind: SymlinkKind.Directory\r\n        });\r\n      }\r\n    }\r\n  }\r\n}\r\n"]}