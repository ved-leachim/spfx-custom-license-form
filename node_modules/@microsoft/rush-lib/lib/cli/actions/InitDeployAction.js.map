{"version":3,"file":"InitDeployAction.js","sourceRoot":"","sources":["../../../src/cli/actions/InitDeployAction.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;;;;;;;;;;;;;;;;;;;;;;;;AAE3D,2CAA6B;AAC7B,oDAA4B;AAC5B,qDAAkD;AAGlD,oEAAuE;AAEvE,gGAA6F;AAE7F,MAAa,gBAAiB,SAAQ,+BAAc;IAQlD,YAAmB,MAA6B;QAC9C,KAAK,CAAC;YACJ,UAAU,EAAE,aAAa;YACzB,OAAO,EAAE,uEAAuE;YAChF,aAAa,EACX,uFAAuF;gBACvF,kGAAkG;gBAClG,uGAAuG;YACzG,MAAM;SACP,CAAC,CAAC;IACL,CAAC;IAES,kBAAkB;QAC1B,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,qBAAqB,CAAC;YACzC,iBAAiB,EAAE,WAAW;YAC9B,kBAAkB,EAAE,IAAI;YACxB,YAAY,EAAE,cAAc;YAC5B,QAAQ,EAAE,IAAI;YACd,WAAW,EACT,8EAA8E;gBAC9E,4DAA4D;SAC/D,CAAC,CAAC;QAEH,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,qBAAqB,CAAC;YAC1C,iBAAiB,EAAE,YAAY;YAC/B,kBAAkB,EAAE,IAAI;YACxB,YAAY,EAAE,UAAU;YACxB,WAAW,EACT,+FAA+F;gBAC/F,6GAA6G;gBAC7G,yGAAyG;SAC5G,CAAC,CAAC;IACL,CAAC;IAES,KAAK,CAAC,QAAQ;QACtB,MAAM,gBAAgB,GAAW,yDAA2B,CAAC,iBAAiB,CAC5E,IAAI,CAAC,SAAS,CAAC,KAAK,EACpB,IAAI,CAAC,iBAAiB,CACvB,CAAC;QAEF,IAAI,8BAAU,CAAC,MAAM,CAAC,gBAAgB,CAAC,EAAE;YACvC,MAAM,IAAI,KAAK,CACb,mCAAmC;gBACjC,gBAAgB;gBAChB,kEAAkE,CACrE,CAAC;SACH;QAED,OAAO,CAAC,GAAG,CAAC,gBAAM,CAAC,KAAK,CAAC,0BAA0B,CAAC,GAAG,gBAAgB,CAAC,CAAC;QAEzE,MAAM,gBAAgB,GAAW,IAAI,CAAC,QAAQ,CAAC,KAAM,CAAC;QACtD,MAAM,WAAW,GAED,IAAI,CAAC,iBAAiB,CAAC,0BAA0B,CAAC,gBAAgB,CAAC,CAAC;QACpF,IAAI,CAAC,WAAW,EAAE;YAChB,MAAM,IAAI,KAAK,CAAC,sDAAsD,gBAAgB,GAAG,CAAC,CAAC;SAC5F;QAED,MAAM,eAAe,GAAW,8BAAU,CAAC,QAAQ,CAAC,gBAAgB,CAAC,qBAAqB,CAAC,CAAC;QAC5F,MAAM,eAAe,GAAW,eAAe,CAAC,OAAO,CACrD,4BAA4B,EAC5B,WAAW,CAAC,WAAW,CACxB,CAAC;QAEF,8BAAU,CAAC,SAAS,CAAC,gBAAgB,EAAE,eAAe,EAAE;YACtD,kBAAkB,EAAE,IAAI;YACxB,kBAAkB,sBAAuB;SAC1C,CAAC,CAAC;QAEH,OAAO,CAAC,GAAG,CAAC,iFAAiF,CAAC,CAAC;IACjG,CAAC;;AA9EH,4CA+EC;AA9EgB,sCAAqB,GAAW,IAAI,CAAC,IAAI,CACtD,SAAS,EACT,yDAAyD,CAC1D,CAAC","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as path from 'path';\r\nimport colors from 'colors';\r\nimport { BaseRushAction } from './BaseRushAction';\r\nimport { RushCommandLineParser } from '../RushCommandLineParser';\r\nimport { CommandLineStringParameter } from '@rushstack/ts-command-line';\r\nimport { FileSystem, NewlineKind } from '@rushstack/node-core-library';\r\nimport { RushConfigurationProject } from '../../api/RushConfigurationProject';\r\nimport { DeployScenarioConfiguration } from '../../logic/deploy/DeployScenarioConfiguration';\r\n\r\nexport class InitDeployAction extends BaseRushAction {\r\n  private static _CONFIG_TEMPLATE_PATH: string = path.join(\r\n    __dirname,\r\n    '../../../assets/rush-init-deploy/scenario-template.json'\r\n  );\r\n  private _project!: CommandLineStringParameter;\r\n  private _scenario!: CommandLineStringParameter;\r\n\r\n  public constructor(parser: RushCommandLineParser) {\r\n    super({\r\n      actionName: 'init-deploy',\r\n      summary: 'Creates a deployment scenario config file for use with \"rush deploy\".',\r\n      documentation:\r\n        'Use this command to initialize a new scenario config file for use with \"rush deploy\".' +\r\n        ' The default filename is common/config/rush/deploy.json. However, if you need to manage multiple' +\r\n        ' deployments with different settings, you can use use \"--scenario\" to create additional config files.',\r\n      parser\r\n    });\r\n  }\r\n\r\n  protected onDefineParameters(): void {\r\n    this._project = this.defineStringParameter({\r\n      parameterLongName: '--project',\r\n      parameterShortName: '-p',\r\n      argumentName: 'PROJECT_NAME',\r\n      required: true,\r\n      description:\r\n        'Specifies the name of the main Rush project to be deployed in this scenario.' +\r\n        ' It will be added to the \"deploymentProjectNames\" setting.'\r\n    });\r\n\r\n    this._scenario = this.defineStringParameter({\r\n      parameterLongName: '--scenario',\r\n      parameterShortName: '-s',\r\n      argumentName: 'SCENARIO',\r\n      description:\r\n        'By default, the deployment configuration will be written to \"common/config/rush/deploy.json\".' +\r\n        ' You can use \"--scenario\" to specify an alternate name. The name must be lowercase and separated by dashes.' +\r\n        ' For example, if the name is \"web\", then the config file would be \"common/config/rush/deploy-web.json\".'\r\n    });\r\n  }\r\n\r\n  protected async runAsync(): Promise<void> {\r\n    const scenarioFilePath: string = DeployScenarioConfiguration.getConfigFilePath(\r\n      this._scenario.value,\r\n      this.rushConfiguration\r\n    );\r\n\r\n    if (FileSystem.exists(scenarioFilePath)) {\r\n      throw new Error(\r\n        'The target file already exists:\\n' +\r\n          scenarioFilePath +\r\n          '\\nIf you intend to replace it, please delete the old file first.'\r\n      );\r\n    }\r\n\r\n    console.log(colors.green('Creating scenario file: ') + scenarioFilePath);\r\n\r\n    const shortProjectName: string = this._project.value!;\r\n    const rushProject:\r\n      | RushConfigurationProject\r\n      | undefined = this.rushConfiguration.findProjectByShorthandName(shortProjectName);\r\n    if (!rushProject) {\r\n      throw new Error(`The specified project was not found in rush.json: \"${shortProjectName}\"`);\r\n    }\r\n\r\n    const templateContent: string = FileSystem.readFile(InitDeployAction._CONFIG_TEMPLATE_PATH);\r\n    const expandedContent: string = templateContent.replace(\r\n      '[%PROJECT_NAME_TO_DEPLOY%]',\r\n      rushProject.packageName\r\n    );\r\n\r\n    FileSystem.writeFile(scenarioFilePath, expandedContent, {\r\n      ensureFolderExists: true,\r\n      convertLineEndings: NewlineKind.OsDefault\r\n    });\r\n\r\n    console.log('\\nFile successfully written. Please review the file contents before committing.');\r\n  }\r\n}\r\n"]}