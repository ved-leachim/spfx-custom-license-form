{"version":3,"file":"Utilities.js","sourceRoot":"","sources":["../../src/utilities/Utilities.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as child_process from 'child_process';\r\nimport * as fs from 'fs';\r\nimport * as os from 'os';\r\nimport * as tty from 'tty';\r\nimport * as path from 'path';\r\nimport wordwrap from 'wordwrap';\r\nimport { JsonFile, IPackageJson, FileSystem, FileConstants, Terminal } from '@rushstack/node-core-library';\r\nimport { Stream } from 'stream';\r\nimport { CommandLineHelper } from '@rushstack/ts-command-line';\r\n\r\nimport { RushConfiguration } from '../api/RushConfiguration';\r\n\r\nexport interface IEnvironment {\r\n  // NOTE: the process.env doesn't actually support \"undefined\" as a value.\r\n  // If you try to assign it, it will be converted to the text string \"undefined\".\r\n  // But this typing is needed for reading values from the dictionary, and for\r\n  // subsets that get combined.\r\n  [environmentVariableName: string]: string | undefined;\r\n}\r\n\r\n/**\r\n * Options for Utilities.executeCommand().\r\n */\r\nexport interface IExecuteCommandOptions {\r\n  command: string;\r\n  args: string[];\r\n  workingDirectory: string;\r\n  environment?: IEnvironment;\r\n  suppressOutput?: boolean;\r\n  keepEnvironment?: boolean;\r\n}\r\n\r\n/**\r\n * Options for Utilities.installPackageInDirectory().\r\n */\r\nexport interface IInstallPackageInDirectoryOptions {\r\n  directory: string;\r\n  packageName: string;\r\n  version: string;\r\n  tempPackageTitle: string;\r\n  maxInstallAttempts: number;\r\n  commonRushConfigFolder: string | undefined;\r\n  suppressOutput?: boolean;\r\n}\r\n\r\nexport interface ILifecycleCommandOptions {\r\n  /**\r\n   * The rush configuration, if the command is running in a rush repo.\r\n   */\r\n  rushConfiguration: RushConfiguration | undefined;\r\n\r\n  /**\r\n   * Working directory for running the command\r\n   */\r\n  workingDirectory: string;\r\n\r\n  /**\r\n   * The folder containing a local .npmrc, which will be used for the INIT_CWD environment variable\r\n   */\r\n  initCwd: string;\r\n\r\n  /**\r\n   * If true, suppress the process's output, but if there is a nonzero exit code then print stderr\r\n   */\r\n  handleOutput: boolean;\r\n\r\n  /**\r\n   * Options for what should be added to the PATH variable\r\n   */\r\n  environmentPathOptions: IEnvironmentPathOptions;\r\n}\r\n\r\nexport interface IEnvironmentPathOptions {\r\n  /**\r\n   * If true, include <project root>/node_modules/.bin in the PATH. If both this and\r\n   * {@link IEnvironmentPathOptions.includeRepoBin} are set, this path will take precedence.\r\n   */\r\n  includeProjectBin?: boolean;\r\n\r\n  /**\r\n   * If true, include <repo root>/common/temp/node_modules/.bin in the PATH.\r\n   */\r\n  includeRepoBin?: boolean;\r\n\r\n  /**\r\n   * Additional folders to be prepended to the search PATH.\r\n   */\r\n  additionalPathFolders?: string[] | undefined;\r\n}\r\n\r\nexport interface IDisposable {\r\n  dispose(): void;\r\n}\r\n\r\ninterface ICreateEnvironmentForRushCommandPathOptions extends IEnvironmentPathOptions {\r\n  projectRoot: string | undefined;\r\n  commonTempFolder: string | undefined;\r\n}\r\n\r\ninterface ICreateEnvironmentForRushCommandOptions {\r\n  /**\r\n   * The INIT_CWD environment variable\r\n   */\r\n  initCwd?: string;\r\n\r\n  /**\r\n   * an existing environment to copy instead of process.env\r\n   */\r\n  initialEnvironment?: IEnvironment;\r\n\r\n  /**\r\n   * Options for what should be added to the PATH variable\r\n   */\r\n  pathOptions?: ICreateEnvironmentForRushCommandPathOptions;\r\n}\r\n\r\nexport class Utilities {\r\n  /**\r\n   * Get the user's home directory. On windows this looks something like \"C:\\users\\username\\\" and on UNIX\r\n   * this looks something like \"/home/username/\"\r\n   */\r\n  public static getHomeFolder(): string {\r\n    const unresolvedUserFolder: string | undefined =\r\n      process.env[process.platform === 'win32' ? 'USERPROFILE' : 'HOME'];\r\n    const dirError: string = \"Unable to determine the current user's home directory\";\r\n    if (unresolvedUserFolder === undefined) {\r\n      throw new Error(dirError);\r\n    }\r\n    const homeFolder: string = path.resolve(unresolvedUserFolder);\r\n    if (!FileSystem.exists(homeFolder)) {\r\n      throw new Error(dirError);\r\n    }\r\n\r\n    return homeFolder;\r\n  }\r\n\r\n  /**\r\n   * Node.js equivalent of performance.now().\r\n   */\r\n  public static getTimeInMs(): number {\r\n    const [seconds, nanoseconds] = process.hrtime();\r\n    return seconds * 1000 + nanoseconds / 1000000;\r\n  }\r\n\r\n  /**\r\n   * Returns the values from a Set<T>\r\n   */\r\n  public static getSetAsArray<T>(set: Set<T>): T[] {\r\n    // When ES6 is supported, we can use Array.from() instead.\r\n    const result: T[] = [];\r\n    set.forEach((value: T) => {\r\n      result.push(value);\r\n    });\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Retries a function until a timeout is reached. The function is expected to throw if it failed and\r\n   *  should be retried.\r\n   */\r\n  public static retryUntilTimeout<TResult>(\r\n    fn: () => TResult,\r\n    maxWaitTimeMs: number,\r\n    getTimeoutError: (innerError: Error) => Error,\r\n    fnName: string\r\n  ): TResult {\r\n    const startTime: number = Utilities.getTimeInMs();\r\n    let looped: boolean = false;\r\n\r\n    let result: TResult;\r\n    for (;;) {\r\n      try {\r\n        result = fn();\r\n        break;\r\n      } catch (e) {\r\n        looped = true;\r\n        const currentTime: number = Utilities.getTimeInMs();\r\n        if (currentTime - startTime > maxWaitTimeMs) {\r\n          throw getTimeoutError(e);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (looped) {\r\n      const currentTime: number = Utilities.getTimeInMs();\r\n      const totalSeconds: string = ((currentTime - startTime) / 1000.0).toFixed(2);\r\n      // This logging statement isn't meaningful to the end-user. `fnName` should be updated\r\n      // to something like `operationDescription`\r\n      console.log(`${fnName}() stalled for ${totalSeconds} seconds`);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Creates the specified folder by calling FileSystem.ensureFolder(), but using a\r\n   * retry loop to recover from temporary locks that may be held by other processes.\r\n   * If the folder already exists, no error occurs.\r\n   */\r\n  public static createFolderWithRetry(folderName: string): void {\r\n    // Note: If a file exists with the same name, then we fall through and report\r\n    // an error.\r\n    if (Utilities.directoryExists(folderName)) {\r\n      return;\r\n    }\r\n\r\n    // We need to do a simple \"FileSystem.ensureFolder(localModulesFolder)\" here,\r\n    // however if the folder we deleted above happened to contain any files,\r\n    // then there seems to be some OS process (virus scanner?) that holds\r\n    // a lock on the folder for a split second, which causes mkdirSync to\r\n    // fail.  To workaround that, retry for up to 7 seconds before giving up.\r\n    const maxWaitTimeMs: number = 7 * 1000;\r\n\r\n    return Utilities.retryUntilTimeout(\r\n      () => FileSystem.ensureFolder(folderName),\r\n      maxWaitTimeMs,\r\n      (e) =>\r\n        new Error(\r\n          `Error: ${e}${os.EOL}Often this is caused by a file lock ` +\r\n            'from a process such as your text editor, command prompt, ' +\r\n            'or a filesystem watcher.'\r\n        ),\r\n      'createFolderWithRetry'\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Determines if the path points to a file and that it exists.\r\n   */\r\n  public static fileExists(filePath: string): boolean {\r\n    let exists: boolean = false;\r\n\r\n    try {\r\n      const lstat: fs.Stats = FileSystem.getLinkStatistics(filePath);\r\n      exists = lstat.isFile();\r\n    } catch (e) {\r\n      /* no-op */\r\n    }\r\n\r\n    return exists;\r\n  }\r\n\r\n  /**\r\n   * Determines if a path points to a directory and that it exists.\r\n   */\r\n  public static directoryExists(directoryPath: string): boolean {\r\n    let exists: boolean = false;\r\n\r\n    try {\r\n      const lstat: fs.Stats = FileSystem.getLinkStatistics(directoryPath);\r\n      exists = lstat.isDirectory();\r\n    } catch (e) {\r\n      /* no-op */\r\n    }\r\n\r\n    return exists;\r\n  }\r\n\r\n  /**\r\n   * BE VERY CAREFUL CALLING THIS FUNCTION!\r\n   * If you specify the wrong folderPath (e.g. \"/\"), it could potentially delete your entire\r\n   * hard disk.\r\n   */\r\n  public static dangerouslyDeletePath(folderPath: string): void {\r\n    try {\r\n      FileSystem.deleteFolder(folderPath);\r\n    } catch (e) {\r\n      throw new Error(\r\n        `${e.message}${os.EOL}Often this is caused by a file lock from a process ` +\r\n          'such as your text editor, command prompt, or a filesystem watcher'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Attempts to delete a file. If it does not exist, or the path is not a file, it no-ops.\r\n   */\r\n  public static deleteFile(filePath: string): void {\r\n    if (Utilities.fileExists(filePath)) {\r\n      console.log(`Deleting: ${filePath}`);\r\n      FileSystem.deleteFile(filePath);\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Returns true if dateToCompare is more recent than all of the inputFilenames, which\r\n   * would imply that we don't need to rebuild it. Returns false if any of the files\r\n   * does not exist.\r\n   * NOTE: The filenames can also be paths for directories, in which case the directory\r\n   * timestamp is compared.\r\n   */\r\n  public static isFileTimestampCurrent(dateToCompare: Date, inputFilenames: string[]): boolean {\r\n    for (const inputFilename of inputFilenames) {\r\n      if (!FileSystem.exists(inputFilename)) {\r\n        return false;\r\n      }\r\n\r\n      const inputStats: fs.Stats = FileSystem.getStatistics(inputFilename);\r\n      if (dateToCompare < inputStats.mtime) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Returns the width of the console, measured in columns\r\n   */\r\n  public static getConsoleWidth(): number {\r\n    const stdout: tty.WriteStream = process.stdout as tty.WriteStream;\r\n    if (stdout && stdout.columns) {\r\n      return stdout.columns;\r\n    }\r\n\r\n    return 80;\r\n  }\r\n\r\n  /**\r\n   * Applies word wrapping.  If maxLineLength is unspecified, then it defaults to the console\r\n   * width.\r\n   */\r\n  public static wrapWords(text: string, maxLineLength?: number, indent?: number): string {\r\n    if (!indent) {\r\n      indent = 0;\r\n    }\r\n    if (!maxLineLength) {\r\n      maxLineLength = Utilities.getConsoleWidth();\r\n    }\r\n\r\n    const wrap: (textToWrap: string) => string = wordwrap(indent, maxLineLength, { mode: 'soft' });\r\n    return wrap(text);\r\n  }\r\n\r\n  /**\r\n   * Executes the command with the specified command-line parameters, and waits for it to complete.\r\n   * The current directory will be set to the specified workingDirectory.\r\n   */\r\n  public static executeCommand(options: IExecuteCommandOptions): void {\r\n    Utilities._executeCommandInternal(\r\n      options.command,\r\n      options.args,\r\n      options.workingDirectory,\r\n      options.suppressOutput ? undefined : [0, 1, 2],\r\n      options.environment,\r\n      options.keepEnvironment\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Executes the command with the specified command-line parameters, and waits for it to complete.\r\n   * The current directory will be set to the specified workingDirectory.\r\n   */\r\n  public static executeCommandAndCaptureOutput(\r\n    command: string,\r\n    args: string[],\r\n    workingDirectory: string,\r\n    environment?: IEnvironment,\r\n    keepEnvironment: boolean = false\r\n  ): string {\r\n    const result: child_process.SpawnSyncReturns<Buffer> = Utilities._executeCommandInternal(\r\n      command,\r\n      args,\r\n      workingDirectory,\r\n      ['pipe', 'pipe', 'pipe'],\r\n      environment,\r\n      keepEnvironment\r\n    );\r\n\r\n    return result.stdout.toString();\r\n  }\r\n\r\n  /**\r\n   * Attempts to run Utilities.executeCommand() up to maxAttempts times before giving up.\r\n   */\r\n  public static executeCommandWithRetry(\r\n    options: IExecuteCommandOptions,\r\n    maxAttempts: number,\r\n    retryCallback?: () => void\r\n  ): void {\r\n    if (maxAttempts < 1) {\r\n      throw new Error('The maxAttempts parameter cannot be less than 1');\r\n    }\r\n\r\n    let attemptNumber: number = 1;\r\n\r\n    for (;;) {\r\n      try {\r\n        Utilities.executeCommand(options);\r\n      } catch (error) {\r\n        console.log(os.EOL + 'The command failed:');\r\n        console.log(` ${options.command} ` + options.args.join(' '));\r\n        console.log(`ERROR: ${error.toString()}`);\r\n\r\n        if (attemptNumber < maxAttempts) {\r\n          ++attemptNumber;\r\n          console.log(`Trying again (attempt #${attemptNumber})...` + os.EOL);\r\n          if (retryCallback) {\r\n            retryCallback();\r\n          }\r\n\r\n          continue;\r\n        } else {\r\n          console.error(`Giving up after ${attemptNumber} attempts` + os.EOL);\r\n          throw error;\r\n        }\r\n      }\r\n\r\n      break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Executes the command using cmd if running on windows, or using sh if running on a non-windows OS.\r\n   * @param command - the command to run on shell\r\n   * @param options - options for how the command should be run\r\n   */\r\n  public static executeLifecycleCommand(command: string, options: ILifecycleCommandOptions): number {\r\n    const result: child_process.SpawnSyncReturns<Buffer> = Utilities._executeLifecycleCommandInternal(\r\n      command,\r\n      child_process.spawnSync,\r\n      options\r\n    );\r\n\r\n    if (options.handleOutput) {\r\n      Utilities._processResult(result);\r\n    }\r\n\r\n    if (result.status !== null) {\r\n      return result.status;\r\n    } else {\r\n      throw result.error || new Error('An unknown error occurred.');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Executes the command using cmd if running on windows, or using sh if running on a non-windows OS.\r\n   * @param command - the command to run on shell\r\n   * @param options - options for how the command should be run\r\n   */\r\n  public static executeLifecycleCommandAsync(\r\n    command: string,\r\n    options: ILifecycleCommandOptions\r\n  ): child_process.ChildProcess {\r\n    return Utilities._executeLifecycleCommandInternal(command, child_process.spawn, options);\r\n  }\r\n\r\n  /**\r\n   * Utility to determine if the app should restrict writing to the console.\r\n   */\r\n  public static shouldRestrictConsoleOutput(): boolean {\r\n    return (\r\n      CommandLineHelper.isTabCompletionActionRequest(process.argv) || process.argv.indexOf('--json') !== -1\r\n    );\r\n  }\r\n\r\n  /**\r\n   * For strings passed to a shell command, this adds appropriate escaping\r\n   * to avoid misinterpretation of spaces or special characters.\r\n   *\r\n   * Example: 'hello there' --> '\"hello there\"'\r\n   */\r\n  public static escapeShellParameter(parameter: string): string {\r\n    return `\"${parameter}\"`;\r\n  }\r\n\r\n  /**\r\n   * Installs a package by name and version in the specified directory.\r\n   */\r\n  public static installPackageInDirectory(options: IInstallPackageInDirectoryOptions): void {\r\n    const directory: string = path.resolve(options.directory);\r\n    if (FileSystem.exists(directory)) {\r\n      console.log('Deleting old files from ' + directory);\r\n    }\r\n\r\n    FileSystem.ensureEmptyFolder(directory);\r\n\r\n    const npmPackageJson: IPackageJson = {\r\n      dependencies: {\r\n        [options.packageName]: options.version\r\n      },\r\n      description: 'Temporary file generated by the Rush tool',\r\n      name: options.tempPackageTitle,\r\n      private: true,\r\n      version: '0.0.0'\r\n    };\r\n    JsonFile.save(npmPackageJson, path.join(directory, FileConstants.PackageJson));\r\n\r\n    if (options.commonRushConfigFolder) {\r\n      Utilities.syncNpmrc(options.commonRushConfigFolder, directory);\r\n    }\r\n\r\n    console.log(os.EOL + 'Running \"npm install\" in ' + directory);\r\n\r\n    // NOTE: Here we use whatever version of NPM we happen to find in the PATH\r\n    Utilities.executeCommandWithRetry(\r\n      {\r\n        command: 'npm',\r\n        args: ['install'],\r\n        workingDirectory: directory,\r\n        environment: Utilities._createEnvironmentForRushCommand({}),\r\n        suppressOutput: options.suppressOutput\r\n      },\r\n      options.maxInstallAttempts\r\n    );\r\n  }\r\n\r\n  /**\r\n   * As a workaround, copyAndTrimNpmrcFile() copies the .npmrc file to the target folder, and also trims\r\n   * unusable lines from the .npmrc file.\r\n   *\r\n   * Why are we trimming the .npmrc lines?  NPM allows environment variables to be specified in\r\n   * the .npmrc file to provide different authentication tokens for different registry.\r\n   * However, if the environment variable is undefined, it expands to an empty string, which\r\n   * produces a valid-looking mapping with an invalid URL that causes an error.  Instead,\r\n   * we'd prefer to skip that line and continue looking in other places such as the user's\r\n   * home directory.\r\n   *\r\n   * IMPORTANT: THIS CODE SHOULD BE KEPT UP TO DATE WITH _copyAndTrimNpmrcFile() FROM scripts/install-run.ts\r\n   */\r\n  public static copyAndTrimNpmrcFile(sourceNpmrcPath: string, targetNpmrcPath: string): void {\r\n    console.log(`Copying ${sourceNpmrcPath} --> ${targetNpmrcPath}`); // Verbose\r\n    let npmrcFileLines: string[] = FileSystem.readFile(sourceNpmrcPath).split('\\n');\r\n    npmrcFileLines = npmrcFileLines.map((line) => (line || '').trim());\r\n    const resultLines: string[] = [];\r\n\r\n    // This finds environment variable tokens that look like \"${VAR_NAME}\"\r\n    const expansionRegExp: RegExp = /\\$\\{([^\\}]+)\\}/g;\r\n\r\n    // Comment lines start with \"#\" or \";\"\r\n    const commentRegExp: RegExp = /^\\s*[#;]/;\r\n\r\n    // Trim out lines that reference environment variables that aren't defined\r\n    for (const line of npmrcFileLines) {\r\n      let lineShouldBeTrimmed: boolean = false;\r\n\r\n      // Ignore comment lines\r\n      if (!commentRegExp.test(line)) {\r\n        const environmentVariables: string[] | null = line.match(expansionRegExp);\r\n        if (environmentVariables) {\r\n          for (const token of environmentVariables) {\r\n            // Remove the leading \"${\" and the trailing \"}\" from the token\r\n            const environmentVariableName: string = token.substring(2, token.length - 1);\r\n\r\n            // Is the environment variable defined?\r\n            if (!process.env[environmentVariableName]) {\r\n              // No, so trim this line\r\n              lineShouldBeTrimmed = true;\r\n              break;\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      if (lineShouldBeTrimmed) {\r\n        // Example output:\r\n        // \"; MISSING ENVIRONMENT VARIABLE: //my-registry.com/npm/:_authToken=${MY_AUTH_TOKEN}\"\r\n        resultLines.push('; MISSING ENVIRONMENT VARIABLE: ' + line);\r\n      } else {\r\n        resultLines.push(line);\r\n      }\r\n    }\r\n\r\n    FileSystem.writeFile(targetNpmrcPath, resultLines.join(os.EOL));\r\n  }\r\n\r\n  /**\r\n   * Copies the file \"sourcePath\" to \"destinationPath\", overwriting the target file location.\r\n   * If the source file does not exist, then the target file is deleted.\r\n   */\r\n  public static syncFile(sourcePath: string, destinationPath: string): void {\r\n    if (FileSystem.exists(sourcePath)) {\r\n      console.log(`Updating ${destinationPath}`);\r\n      FileSystem.copyFile({ sourcePath, destinationPath });\r\n    } else {\r\n      if (FileSystem.exists(destinationPath)) {\r\n        // If the source file doesn't exist and there is one in the target, delete the one in the target\r\n        console.log(`Deleting ${destinationPath}`);\r\n        FileSystem.deleteFile(destinationPath);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * syncNpmrc() copies the .npmrc file to the target folder, and also trims unusable lines from the .npmrc file.\r\n   * If the source .npmrc file not exist, then syncNpmrc() will delete an .npmrc that is found in the target folder.\r\n   *\r\n   * IMPORTANT: THIS CODE SHOULD BE KEPT UP TO DATE WITH _syncNpmrc() FROM scripts/install-run.ts\r\n   */\r\n  public static syncNpmrc(\r\n    sourceNpmrcFolder: string,\r\n    targetNpmrcFolder: string,\r\n    useNpmrcPublish?: boolean\r\n  ): void {\r\n    const sourceNpmrcPath: string = path.join(\r\n      sourceNpmrcFolder,\r\n      !useNpmrcPublish ? '.npmrc' : '.npmrc-publish'\r\n    );\r\n    const targetNpmrcPath: string = path.join(targetNpmrcFolder, '.npmrc');\r\n    try {\r\n      if (FileSystem.exists(sourceNpmrcPath)) {\r\n        Utilities.copyAndTrimNpmrcFile(sourceNpmrcPath, targetNpmrcPath);\r\n      } else if (FileSystem.exists(targetNpmrcPath)) {\r\n        // If the source .npmrc doesn't exist and there is one in the target, delete the one in the target\r\n        console.log(`Deleting ${targetNpmrcPath}`); // Verbose\r\n        FileSystem.deleteFile(targetNpmrcPath);\r\n      }\r\n    } catch (e) {\r\n      throw new Error(`Error syncing .npmrc file: ${e}`);\r\n    }\r\n  }\r\n\r\n  public static getRushConfigNotFoundError(): Error {\r\n    return new Error('Unable to find rush.json configuration file');\r\n  }\r\n\r\n  public static getPackageDepsFilenameForCommand(command: string): string {\r\n    return `package-deps_${command}.json`;\r\n  }\r\n\r\n  public static printMessageInBox(\r\n    message: string,\r\n    terminal: Terminal,\r\n    boxWidth: number = Math.floor(Utilities.getConsoleWidth() / 2)\r\n  ): void {\r\n    const maxLineLength: number = boxWidth - 10;\r\n\r\n    const wrappedMessage: string = Utilities.wrapWords(message, maxLineLength);\r\n    const wrappedMessageLines: string[] = wrappedMessage.split('\\n');\r\n\r\n    // ╔═══════════╗\r\n    // ║  Message  ║\r\n    // ╚═══════════╝\r\n    terminal.writeLine(` ╔${'═'.repeat(boxWidth - 2)}╗ `);\r\n    for (const line of wrappedMessageLines) {\r\n      const trimmedLine: string = line.trim();\r\n      const padding: number = boxWidth - trimmedLine.length - 2;\r\n      const leftPadding: number = Math.floor(padding / 2);\r\n      const rightPadding: number = padding - leftPadding;\r\n      terminal.writeLine(` ║${' '.repeat(leftPadding)}${trimmedLine}${' '.repeat(rightPadding)}║ `);\r\n    }\r\n    terminal.writeLine(` ╚${'═'.repeat(boxWidth - 2)}╝ `);\r\n  }\r\n\r\n  public static async usingAsync<TDisposable extends IDisposable>(\r\n    getDisposableAsync: () => Promise<TDisposable> | IDisposable,\r\n    doActionAsync: (disposable: TDisposable) => Promise<void> | void\r\n  ): Promise<void> {\r\n    let disposable: TDisposable | undefined;\r\n    try {\r\n      disposable = (await getDisposableAsync()) as TDisposable;\r\n      await doActionAsync(disposable);\r\n    } finally {\r\n      disposable?.dispose();\r\n    }\r\n  }\r\n\r\n  private static _executeLifecycleCommandInternal<TCommandResult>(\r\n    command: string,\r\n    spawnFunction: (\r\n      command: string,\r\n      args: string[],\r\n      spawnOptions: child_process.SpawnOptions\r\n    ) => TCommandResult,\r\n    options: ILifecycleCommandOptions\r\n  ): TCommandResult {\r\n    let shellCommand: string = process.env.comspec || 'cmd';\r\n    let commandFlags: string = '/d /s /c';\r\n    let useShell: boolean = true;\r\n    if (process.platform !== 'win32') {\r\n      shellCommand = 'sh';\r\n      commandFlags = '-c';\r\n      useShell = false;\r\n    }\r\n\r\n    const environment: IEnvironment = Utilities._createEnvironmentForRushCommand({\r\n      initCwd: options.initCwd,\r\n      pathOptions: {\r\n        ...options.environmentPathOptions,\r\n        projectRoot: options.workingDirectory,\r\n        commonTempFolder: options.rushConfiguration ? options.rushConfiguration.commonTempFolder : undefined\r\n      }\r\n    });\r\n\r\n    return spawnFunction(shellCommand, [commandFlags, command], {\r\n      cwd: options.workingDirectory,\r\n      shell: useShell,\r\n      env: environment,\r\n      stdio: options.handleOutput ? ['pipe', 'pipe', 'pipe'] : [0, 1, 2]\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns a process.env environment suitable for executing lifecycle scripts.\r\n   * @param initialEnvironment - an existing environment to copy instead of process.env\r\n   */\r\n  private static _createEnvironmentForRushCommand(\r\n    options: ICreateEnvironmentForRushCommandOptions\r\n  ): IEnvironment {\r\n    if (options.initialEnvironment === undefined) {\r\n      options.initialEnvironment = process.env;\r\n    }\r\n\r\n    const environment: IEnvironment = {};\r\n    for (const key of Object.getOwnPropertyNames(options.initialEnvironment)) {\r\n      const normalizedKey: string = os.platform() === 'win32' ? key.toUpperCase() : key;\r\n\r\n      // If Rush itself was invoked inside a lifecycle script, this may be set and would interfere\r\n      // with Rush's installations.  If we actually want it, we will set it explicitly below.\r\n      if (normalizedKey === 'INIT_CWD') {\r\n        continue;\r\n      }\r\n\r\n      // When NPM invokes a lifecycle event, it copies its entire configuration into environment\r\n      // variables.  Rush is supposed to be a deterministic controlled environment, so don't bring\r\n      // this along.\r\n      //\r\n      // NOTE: Longer term we should clean out the entire environment and use rush.json to bring\r\n      // back specific environment variables that the repo maintainer has determined to be safe.\r\n      if (normalizedKey.match(/^NPM_CONFIG_/)) {\r\n        continue;\r\n      }\r\n\r\n      // Use the uppercased environment variable name on Windows because environment variable names\r\n      // are case-insensitive on Windows\r\n      environment[normalizedKey] = options.initialEnvironment[key];\r\n    }\r\n\r\n    // When NPM invokes a lifecycle script, it sets an environment variable INIT_CWD that remembers\r\n    // the directory that NPM started in.  This allows naive scripts to change their current working directory\r\n    // and invoke NPM operations, while still be able to find a local .npmrc file.  Although Rush recommends\r\n    // for toolchain scripts to be professionally written (versus brittle stuff like\r\n    // \"cd ./lib && npm run tsc && cd ..\"), we support INIT_CWD for compatibility.\r\n    //\r\n    // More about this feature: https://github.com/npm/npm/pull/12356\r\n    if (options.initCwd) {\r\n      environment['INIT_CWD'] = options.initCwd; // eslint-disable-line dot-notation\r\n    }\r\n\r\n    if (options.pathOptions) {\r\n      if (options.pathOptions.includeRepoBin && options.pathOptions.commonTempFolder) {\r\n        environment.PATH = Utilities._prependNodeModulesBinToPath(\r\n          environment.PATH,\r\n          options.pathOptions.commonTempFolder\r\n        );\r\n      }\r\n\r\n      if (options.pathOptions.includeProjectBin && options.pathOptions.projectRoot) {\r\n        environment.PATH = Utilities._prependNodeModulesBinToPath(\r\n          environment.PATH,\r\n          options.pathOptions.projectRoot\r\n        );\r\n      }\r\n\r\n      if (options.pathOptions.additionalPathFolders) {\r\n        environment.PATH = [...options.pathOptions.additionalPathFolders, environment.PATH].join(\r\n          path.delimiter\r\n        );\r\n      }\r\n    }\r\n\r\n    return environment;\r\n  }\r\n\r\n  /**\r\n   * Prepend the node_modules/.bin folder under the specified folder to the specified PATH variable. For example,\r\n   * if `rootDirectory` is \"/foobar\" and `existingPath` is \"/bin\", this function will return\r\n   * \"/foobar/node_modules/.bin:/bin\"\r\n   */\r\n  private static _prependNodeModulesBinToPath(\r\n    existingPath: string | undefined,\r\n    rootDirectory: string\r\n  ): string {\r\n    const binPath: string = path.resolve(rootDirectory, 'node_modules', '.bin');\r\n    if (existingPath) {\r\n      return `${binPath}${path.delimiter}${existingPath}`;\r\n    } else {\r\n      return binPath;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Executes the command with the specified command-line parameters, and waits for it to complete.\r\n   * The current directory will be set to the specified workingDirectory.\r\n   */\r\n  private static _executeCommandInternal(\r\n    command: string,\r\n    args: string[],\r\n    workingDirectory: string,\r\n    stdio:\r\n      | 'pipe'\r\n      | 'ignore'\r\n      | 'inherit'\r\n      | (number | 'pipe' | 'ignore' | 'inherit' | 'ipc' | Stream | null | undefined)[]\r\n      | undefined,\r\n    environment?: IEnvironment,\r\n    keepEnvironment: boolean = false\r\n  ): child_process.SpawnSyncReturns<Buffer> {\r\n    const options: child_process.SpawnSyncOptions = {\r\n      cwd: workingDirectory,\r\n      shell: true,\r\n      stdio: stdio,\r\n      env: keepEnvironment\r\n        ? environment\r\n        : Utilities._createEnvironmentForRushCommand({ initialEnvironment: environment })\r\n    };\r\n\r\n    // This is needed since we specify shell=true below.\r\n    // NOTE: On Windows if we escape \"NPM\", the spawnSync() function runs something like this:\r\n    //   [ 'C:\\\\Windows\\\\system32\\\\cmd.exe', '/s', '/c', '\"\"NPM\" \"install\"\"' ]\r\n    //\r\n    // Due to a bug with Windows cmd.exe, the npm.cmd batch file's \"%~dp0\" variable will\r\n    // return the current working directory instead of the batch file's directory.\r\n    // The workaround is to not escape, npm, i.e. do this instead:\r\n    //   [ 'C:\\\\Windows\\\\system32\\\\cmd.exe', '/s', '/c', '\"npm \"install\"\"' ]\r\n    //\r\n    // We will come up with a better solution for this when we promote executeCommand()\r\n    // into node-core-library, but for now this hack will unblock people:\r\n\r\n    // Only escape the command if it actually contains spaces:\r\n    const escapedCommand: string =\r\n      command.indexOf(' ') < 0 ? command : Utilities.escapeShellParameter(command);\r\n\r\n    const escapedArgs: string[] = args.map((x) => Utilities.escapeShellParameter(x));\r\n\r\n    let result: child_process.SpawnSyncReturns<Buffer> = child_process.spawnSync(\r\n      escapedCommand,\r\n      escapedArgs,\r\n      options\r\n    );\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    if (result.error && (result.error as any).errno === 'ENOENT') {\r\n      // This is a workaround for GitHub issue #25330\r\n      // https://github.com/nodejs/node-v0.x-archive/issues/25330\r\n      result = child_process.spawnSync(command + '.cmd', args, options);\r\n    }\r\n\r\n    Utilities._processResult(result);\r\n    return result;\r\n  }\r\n\r\n  private static _processResult(result: child_process.SpawnSyncReturns<Buffer>): void {\r\n    if (result.error) {\r\n      result.error.message += os.EOL + (result.stderr ? result.stderr.toString() + os.EOL : '');\r\n      throw result.error;\r\n    }\r\n\r\n    if (result.status) {\r\n      throw new Error(\r\n        'The command failed with exit code ' +\r\n          result.status +\r\n          os.EOL +\r\n          (result.stderr ? result.stderr.toString() : '')\r\n      );\r\n    }\r\n  }\r\n}\r\n"]}