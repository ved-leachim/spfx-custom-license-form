import { _QosMonitor } from '@microsoft/sp-diagnostics';
import { TokenStorage } from './TokenStorage';
import { TokenRequestManager } from './TokenRequestManager';
import { AadKillSwitches } from '../../AadKillSwitches';
/**
 * Class that wraps the replaces ADALs usage.
 * Shamelessly reuses code snippets from ADAL/MSAL.JS
 * Hoping to deprecate/delete when MSAL is production ready.
 * @internal
 */
var ImplicitFlowTokenProvider = /** @class */ (function () {
    function ImplicitFlowTokenProvider(configuration) {
        this._configuration = configuration;
        this._tokenStorage = new TokenStorage(configuration);
        this._tokenRequestManager = new TokenRequestManager(configuration);
    }
    /**
     * Performs a retry and drops the login hint.
     * @param resourceUri
     * @param useCachedToken
     */
    ImplicitFlowTokenProvider.prototype.getToken = function (resourceUri, useCachedToken) {
        var _this = this;
        if (useCachedToken === void 0) { useCachedToken = true; }
        var acquireAccessTokenQosMonitor = new _QosMonitor('ImplicitTokenProvider.GetAccessTokenSilent');
        var extraData = this._tokenRequestManager._generateTelemetryExtraData(resourceUri, this._configuration.spRequestGuid);
        var cachedToken = this._tokenStorage.getToken(resourceUri);
        if (AadKillSwitches.isUpdateTokenForImplicitTokenProviderEnabled()
            ? useCachedToken && cachedToken
            : cachedToken) {
            extraData.alias = 'true';
            acquireAccessTokenQosMonitor.writeSuccess(extraData);
            return Promise.resolve(cachedToken);
        }
        return this._tokenRequestManager
            .getToken(resourceUri, true)
            .then(function (response) {
            if (TokenRequestManager.isSuccessfulResponse(response)) {
                _this._tokenStorage.saveToken(response, resourceUri);
                acquireAccessTokenQosMonitor.writeSuccess(extraData);
                return response.token;
            }
            else {
                throw new Error(response.errorCode + ': ' + response.errorDescription);
            }
        })
            .catch(function (e) {
            if (TokenRequestManager.isExpectedError(e.message)) {
                acquireAccessTokenQosMonitor.writeExpectedFailure('GetTokenFailure', e);
            }
            else {
                acquireAccessTokenQosMonitor.writeUnexpectedFailure('GetTokenFailure', e);
            }
            throw e;
        });
    };
    return ImplicitFlowTokenProvider;
}());
export { ImplicitFlowTokenProvider };
//# sourceMappingURL=ImplicitFlowTokenProvider.js.map