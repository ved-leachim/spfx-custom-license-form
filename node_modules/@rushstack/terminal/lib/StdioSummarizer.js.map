{"version":3,"file":"StdioSummarizer.js","sourceRoot":"","sources":["../src/StdioSummarizer.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport { ITerminalChunk, TerminalChunkKind } from './ITerminalChunk';\r\nimport { TerminalWritable } from './TerminalWritable';\r\n\r\n/**\r\n * Constructor options for {@link StdioSummarizer}.\r\n * @beta\r\n */\r\nexport interface IStdioSummarizerOptions {\r\n  /**\r\n   * Specifies the maximum number of leading lines to include in the summary.\r\n   * @defaultValue `10`\r\n   */\r\n  leadingLines?: number;\r\n\r\n  /**\r\n   * Specifies the maximum number of trailing lines to include in the summary.\r\n   * @defaultValue `10`\r\n   */\r\n  trailingLines?: number;\r\n}\r\n\r\n/**\r\n * Summarizes the results of a failed build task by returning a subset of `stderr` output not to exceed\r\n * a specified maximum number of lines.\r\n *\r\n * @remarks\r\n * IMPORTANT: This transform assumes that its input was prepared by {@link StderrLineTransform}, so that each\r\n * {@link ITerminalChunk.text} item is a single line terminated by a `\"\\n\"` character.\r\n *\r\n * The {@link IStdioSummarizerOptions.leadingLines} and {@link IStdioSummarizerOptions.trailingLines}\r\n * counts specify the maximum number of lines to be returned. Any additional lines will be omitted.\r\n * For example, if `leadingLines` and `trailingLines` were set to `3`, then the summary of 16 `stderr` lines might\r\n * look like this:\r\n *\r\n * ```\r\n * Line 1\r\n * Line 2\r\n * Line 3\r\n *   ...10 lines omitted...\r\n * Line 14\r\n * Line 15\r\n * Line 16\r\n * ```\r\n *\r\n * If the `stderr` output is completely empty, then the `stdout` output will be summarized instead.\r\n *\r\n * @beta\r\n */\r\nexport class StdioSummarizer extends TerminalWritable {\r\n  // Capture up to this many leading lines\r\n  private _leadingLines: number;\r\n\r\n  // Capture up to this many trailing lines\r\n  private _trailingLines: number;\r\n\r\n  private readonly _abridgedLeading: string[];\r\n  private readonly _abridgedTrailing: string[];\r\n  private _abridgedOmittedLines: number = 0;\r\n  private _abridgedStderr: boolean;\r\n\r\n  public constructor(options?: IStdioSummarizerOptions) {\r\n    super();\r\n\r\n    if (!options) {\r\n      options = {};\r\n    }\r\n\r\n    this._leadingLines = options.leadingLines !== undefined ? options.leadingLines : 10;\r\n    this._trailingLines = options.trailingLines !== undefined ? options.trailingLines : 10;\r\n\r\n    this._abridgedLeading = [];\r\n    this._abridgedTrailing = [];\r\n    this._abridgedStderr = false;\r\n  }\r\n\r\n  /**\r\n   * Returns the summary report.\r\n   *\r\n   * @remarks\r\n   * The `close()` method must be called before `getReport()` can be used.\r\n   */\r\n  public getReport(): string {\r\n    if (this.isOpen) {\r\n      throw new Error('The summary cannot be prepared until after close() is called.');\r\n    }\r\n    const report: string[] = [...this._abridgedLeading];\r\n    if (this._abridgedOmittedLines === 1) {\r\n      report.push(`  ...${this._abridgedOmittedLines} line omitted...\\n`);\r\n    }\r\n    if (this._abridgedOmittedLines > 1) {\r\n      report.push(`  ...${this._abridgedOmittedLines} lines omitted...\\n`);\r\n    }\r\n    report.push(...this._abridgedTrailing);\r\n    return report.join('');\r\n  }\r\n\r\n  public onWriteChunk(chunk: ITerminalChunk): void {\r\n    if (chunk.text.length === 0 || chunk.text[chunk.text.length - 1] !== '\\n') {\r\n      throw new Error(\r\n        'StdioSummarizer expects chunks that were separated parsed into lines by StderrLineTransform\\n' +\r\n          ' Invalid input: ' +\r\n          JSON.stringify(chunk.text)\r\n      );\r\n    }\r\n\r\n    if (chunk.kind === TerminalChunkKind.Stderr && !this._abridgedStderr) {\r\n      // The first time we see stderr, switch to capturing stderr\r\n      this._abridgedStderr = true;\r\n      this._abridgedLeading.length = 0;\r\n      this._abridgedTrailing.length = 0;\r\n      this._abridgedOmittedLines = 0;\r\n    } else if (this._abridgedStderr && chunk.kind !== TerminalChunkKind.Stderr) {\r\n      // If we're capturing stderr, then ignore non-stderr input\r\n      return;\r\n    }\r\n\r\n    // Did we capture enough leading lines?\r\n    if (this._abridgedLeading.length < this._leadingLines) {\r\n      this._abridgedLeading.push(chunk.text);\r\n      return;\r\n    }\r\n\r\n    this._abridgedTrailing.push(chunk.text);\r\n\r\n    // If we captured to many trailing lines, omit the extras\r\n    while (this._abridgedTrailing.length > this._trailingLines) {\r\n      this._abridgedTrailing.shift();\r\n      ++this._abridgedOmittedLines;\r\n    }\r\n  }\r\n}\r\n"]}